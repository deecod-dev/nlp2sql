{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CSV File</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        /* Add some basic CSS to hide the input and output initially */
        #query-container, #output-container {
            display: none;
        }
        #output-container {
            display: none;
            max-height: 400px;  /* Limit the height */
            overflow: auto;  /* Make it scrollable */
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
        }

        /* Style for an expandable button */
        #expand-btn {
            display: none;
            margin-top: 10px;
            cursor: pointer;
            color: #007BFF;
        }

        /* Style for the expanded output */
        #output-container.expanded {
            max-height: none;
            height: auto;
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header>
        <h1>Upload a CSV File</h1>
        <p>Drag and drop a file, or click to select one</p>
    </header>

    <!-- File Upload Section -->
    <div class="upload-container">
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'process_file' %}">
            {% csrf_token %}
            <input type="file" id="file-input" name="file" accept=".csv" hidden>
            <div id="drop-area" class="drop-area">
                <p>Drag & Drop your file here or <span class="browse-btn">Browse</span></p>
            </div>
            <p id="file-name"></p>
            <button type="submit" class="upload-btn">Upload File</button>
        </form>
    </div>

    <!-- Query Input Section (Initially Hidden) -->
    <div id="query-container" class="query-container">
        <h2>Enter Your Query:</h2>
        <textarea id="query-input" rows="5" cols="50"></textarea><br><br>
        <button id="get-output-btn" class="get-output-btn">Get Output</button>
    </div>

    <!-- Output Section (Initially Hidden) -->
    <div id="output-container" class="output-container">
        <h2>Query Output:</h2>
        <pre id="query-output"></pre>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadForm = document.getElementById('upload-form');
        const queryContainer = document.getElementById('query-container');
        const outputContainer = document.getElementById('output-container');
        const getOutputBtn = document.getElementById('get-output-btn');
        const queryInput = document.getElementById('query-input');
        const queryOutput = document.getElementById('query-output');

        dropArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                fileNameDisplay.textContent = event.target.files[0].name;
            }
        });

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropArea.classList.add('drag-over');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('drag-over');
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            dropArea.classList.remove('drag-over');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileNameDisplay.textContent = files[0].name;
            }
        });

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();  // Prevent default form submission

            // Check if a file is selected
            if (!fileInput.files.length) {
                alert("Please select a file before uploading.");
                return;
            }

            // Prepare FormData to send the file
            const formData = new FormData(uploadForm);

            try {
                // Send the file to the server using fetch (AJAX)
                const response = await fetch('{% url "process_file" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value  // CSRF token
                    }
                });

                const data = await response.json();
                console.log(data);

                if (data.message === 'File successfully uploaded') {
                    // File upload success, now hide the form and show the query input section
                    uploadForm.style.display = 'none';  // Hide the upload section
                    queryContainer.style.display = 'block';  // Show the query section
                } else {
                    alert("Error uploading file: " + data.error);
                }
            } catch (error) {
                alert('Error in file upload: ' + error.message);
            }
        });

        // Handle "Get Output" button click
        getOutputBtn.addEventListener('click', async (event) => {
            const query = queryInput.value.trim();
            if (query) {
                try {
                    // Send the query to the backend using Fetch API
                    const response = await fetch('/process-query/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,  // CSRF token
                        },
                        body: `query=${encodeURIComponent(query)}`
                    });

                    const data = await response.json();

                    if (data.result) {
                        // Process the result and render it in a table
                        renderQueryResults(data.result);
                        outputContainer.style.display = 'block';
                    } else if (data.error) {
                        queryOutput.textContent = `Error: ${data.error}`;
                        outputContainer.style.display = 'block';
                    }
                } catch (error) {
                    alert('Error in fetching data from the server.');
                }
            } else {
                alert('Please enter a query.');
            }
        });

        function renderQueryResults(results) {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();

            // Create table headers
            const headerRow = thead.insertRow();
            Object.keys(results[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });

            // Create table rows
            results.forEach(row => {
                const tr = tbody.insertRow();
                Object.values(row).forEach(value => {
                    const td = tr.insertCell();
                    td.textContent = value;
                });
            });

            // Append the table to the output container
            const queryOutput = document.getElementById('query-output');
            queryOutput.innerHTML = '';  // Clear previous content
            queryOutput.appendChild(table);

            // Handle the expandable output logic
            const expandBtn = document.getElementById('expand-btn');
            const outputContainer = document.getElementById('output-container');

            if (results.length > 10) {  // If the result has more than 10 rows, show the expand button
                expandBtn.style.display = 'inline-block';
                expandBtn.addEventListener('click', () => {
                    outputContainer.classList.toggle('expanded');  // Toggle the expanded class
                });
            }
        }
    </script>

</body>
</html>
